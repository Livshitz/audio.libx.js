<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Beat Detection Example - audio.libx.js</title>
	<style>
		body {
			font-family: system-ui, -apple-system, sans-serif;
			max-width: 800px;
			margin: 50px auto;
			padding: 20px;
			background: #f5f5f5;
		}

		.container {
			background: white;
			padding: 30px;
			border-radius: 10px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.controls {
			margin: 20px 0;
		}

		button {
			padding: 10px 20px;
			margin: 5px;
			border: none;
			border-radius: 5px;
			background: #007bff;
			color: white;
			cursor: pointer;
			font-size: 14px;
		}

		button:hover {
			background: #0056b3;
		}

		button:disabled {
			background: #ccc;
			cursor: not-allowed;
		}

		.beat-indicator {
			width: 100px;
			height: 100px;
			border-radius: 50%;
			background: #ddd;
			margin: 20px auto;
			transition: all 0.1s ease;
		}

		.beat-indicator.active {
			background: #ff0066;
			transform: scale(1.2);
			box-shadow: 0 0 30px rgba(255, 0, 102, 0.8);
		}

		.stats {
			margin-top: 20px;
			padding: 15px;
			background: #f8f9fa;
			border-radius: 5px;
			font-family: monospace;
			font-size: 13px;
		}

		.slider-group {
			margin: 15px 0;
		}

		label {
			display: block;
			margin-bottom: 5px;
			font-weight: 500;
		}

		input[type="range"] {
			width: 100%;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>üéµ Beat Detection Demo</h1>
		<p>Play music and watch the beat detector in action!</p>

		<div class="controls">
			<input type="file" id="audioFile" accept="audio/*">
			<br><br>
			<button id="playBtn">Play</button>
			<button id="pauseBtn">Pause</button>
			<button id="startDetectionBtn">Start Detection</button>
			<button id="stopDetectionBtn">Stop Detection</button>
		</div>

		<div class="slider-group">
			<label>Sensitivity: <span id="sensitivityValue">2.0</span></label>
			<input type="range" id="sensitivity" min="0.5" max="5" step="0.1" value="2.0">
		</div>

		<div class="slider-group">
			<label>Cooldown (ms): <span id="cooldownValue">200</span></label>
			<input type="range" id="cooldown" min="50" max="500" step="10" value="200">
		</div>

		<div class="beat-indicator" id="beatIndicator"></div>

		<div class="stats">
			<div><strong>Beat Detection Stats:</strong></div>
			<div id="stats">
				Beats detected: 0<br>
				Last beat strength: -<br>
				Current energy: 0.000<br>
				Avg energy: 0.000<br>
				Status: Not started
			</div>
		</div>

		<audio id="audioElement" controls style="width: 100%; margin-top: 20px;"></audio>
	</div>

	<script type="module">
		import { BeatDetector } from '../build/BeatDetector.js';

		const audioElement = document.getElementById('audioElement');
		const audioFile = document.getElementById('audioFile');
		const playBtn = document.getElementById('playBtn');
		const pauseBtn = document.getElementById('pauseBtn');
		const startDetectionBtn = document.getElementById('startDetectionBtn');
		const stopDetectionBtn = document.getElementById('stopDetectionBtn');
		const beatIndicator = document.getElementById('beatIndicator');
		const stats = document.getElementById('stats');
		const sensitivitySlider = document.getElementById('sensitivity');
		const cooldownSlider = document.getElementById('cooldown');
		const sensitivityValue = document.getElementById('sensitivityValue');
		const cooldownValue = document.getElementById('cooldownValue');

		let beatDetector = new BeatDetector({
			sensitivity: 2.0,
			cooldown: 200
		});

		let beatCount = 0;
		let lastStrength = '-';

		// File selection
		audioFile.addEventListener('change', (e) => {
			const file = e.target.files[0];
			if (file) {
				const url = URL.createObjectURL(file);
				audioElement.src = url;
			}
		});

		// Playback controls
		playBtn.addEventListener('click', () => {
			audioElement.play();
		});

		pauseBtn.addEventListener('click', () => {
			audioElement.pause();
		});

		// Detection controls
		startDetectionBtn.addEventListener('click', async () => {
			try {
				if (!beatDetector.isRunning()) {
					await beatDetector.connectAudioElement(audioElement);
					beatDetector.start();
					updateStats();
				}
			} catch (error) {
				alert('Error starting beat detection: ' + error.message);
				console.error(error);
			}
		});

		stopDetectionBtn.addEventListener('click', () => {
			beatDetector.stop();
			updateStats();
		});

		// Sensitivity control
		sensitivitySlider.addEventListener('input', (e) => {
			const value = parseFloat(e.target.value);
			sensitivityValue.textContent = value.toFixed(1);
			beatDetector.setSensitivity(value);
		});

		// Cooldown control
		cooldownSlider.addEventListener('input', (e) => {
			const value = parseInt(e.target.value);
			cooldownValue.textContent = value;
			beatDetector.setCooldown(value);
		});

		// Beat events
		beatDetector.on('beat', (event) => {
			beatCount++;
			lastStrength = event.data.strength.toFixed(2);

			// Visual feedback
			beatIndicator.classList.add('active');
			setTimeout(() => {
				beatIndicator.classList.remove('active');
			}, 100);

			updateStats();
		});

		beatDetector.on('started', () => {
			console.log('Beat detection started');
			updateStats();
		});

		beatDetector.on('stopped', () => {
			console.log('Beat detection stopped');
			updateStats();
		});

		// Update stats display
		function updateStats() {
			const state = beatDetector.getState();
			stats.innerHTML = `
                Beats detected: ${beatCount}<br>
                Last beat strength: ${lastStrength}<br>
                Current energy: ${state.currentEnergy.toFixed(3)}<br>
                Avg energy: ${state.avgEnergy.toFixed(3)}<br>
                Status: ${state.isRunning ? 'Running ‚úÖ' : 'Stopped ‚è∏'}
            `;
		}

		// Periodic stats update
		setInterval(updateStats, 100);
	</script>
</body>

</html>